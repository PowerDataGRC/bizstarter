{% extends "base.html" %}

{% block title %}Business Startup Activities{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Business Startup Activities</h2>
        <span class="badge bg-primary fs-6" id="total-weight-badge">Total Weight: {{ total_weight }}%</span>
    </div>
    <p>List and prioritize the core activities required to launch your business. The total weight cannot exceed 100%.
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('main.startup_activities') }}">
        <div class="table-responsive">
            <table class="table table-bordered" id="activities-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 25%;">Activity</th>
                        <th style="width: 25%;">Description</th>
                        <th style="width: 10%;">Weight (%)</th>
                        <th style="width: 20%;">Progress</th>
                        <th style="width: 10%;" class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in activities %}
                    <tr>
                        <td><input type="text" name="activity" class="form-control" value="{{ item.activity }}"
                                title="{{ item.activity }}" required></td>
                        <td><input type="text" name="description" class="form-control" value="{{ item.description }}"
                                title="{{ item.description }}">
                        </td>
                        <td><input type="number" name="weight" class="form-control weight-input"
                                value="{{ item.weight }}" min="0" max="100" required></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <input type="range" name="progress" class="form-range progress-slider" min="0" max="100"
                                    step="1" value="{{ item.progress }}">
                                <span class="ms-2 progress-value fw-bold">{{ item.progress }}%</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <i class="bi bi-trash-fill text-danger remove-row-btn"
                                style="cursor: pointer; font-size: 1.2rem;" title="Remove item"></i>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <button type="button" id="add-row-btn" class="btn btn-secondary">Add Activity</button>
            <div class="float-end">
                <button type="submit" name="action" value="save_and_continue" class="btn btn-success">Save and Continue
                    &rarr;</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tableBody = document.querySelector('#activities-table tbody');
        const addRowBtn = document.getElementById('add-row-btn');
        const totalWeightBadge = document.getElementById('total-weight-badge');

        function createRow() {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
            <td><input type="text" name="activity" class="form-control" required title=""></td>
            <td><input type="text" name="description" class="form-control" title=""></td>
            <td><input type="number" name="weight" class="form-control weight-input" min="0" max="100" required></td>
            <td>
                <div class="d-flex align-items-center">
                    <input type="range" name="progress" class="form-range progress-slider" min="0" max="100" step="1" value="0">
                    <span class="ms-2 progress-value fw-bold">0%</span>
                </div>
            </td>
            <td class="text-center">
                <i class="bi bi-trash-fill text-danger remove-row-btn" style="cursor: pointer; font-size: 1.2rem;" title="Remove item"></i>
            </td>
        `;
            tableBody.appendChild(newRow);
            attachEventListeners(newRow);
        }

        function removeRow(button) {
            button.closest('tr').remove();
            updateTotalWeight();
        }

        function updateTotalWeight() {
            let total = 0;
            document.querySelectorAll('.weight-input').forEach(input => {
                const value = parseInt(input.value, 10);
                if (!isNaN(value)) {
                    total += value;
                }
            });
            totalWeightBadge.textContent = `Total Weight: ${total}%`;
            if (total > 100) {
                totalWeightBadge.classList.remove('bg-primary');
                totalWeightBadge.classList.add('bg-danger');
            } else {
                totalWeightBadge.classList.remove('bg-danger');
                totalWeightBadge.classList.add('bg-primary');
            }
        }

        function attachEventListeners(element) {
            element.querySelectorAll('.remove-row-btn').forEach(btn => {
                btn.addEventListener('click', () => removeRow(btn));
            });
            element.querySelectorAll('.weight-input').forEach(input => {
                input.addEventListener('input', updateTotalWeight);
            });
            element.querySelectorAll('.progress-slider').forEach(slider => {
                slider.addEventListener('input', () => slider.nextElementSibling.textContent = `${slider.value}%`);
            });
            // Add listener to update tooltips on text inputs
            element.querySelectorAll('input[name="activity"], input[name="description"]').forEach(input => {
                input.addEventListener('input', () => {
                    input.title = input.value;
                });
            });
        }

        addRowBtn.addEventListener('click', createRow);
        attachEventListeners(document.body);
    });
</script>
{% endblock %}