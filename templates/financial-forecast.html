{% extends "base.html" %}
{% block title %}Financial Forecast{% endblock %} 

{% block head_extra %}
<style>
    /* Custom styles for the seasonality accordion button */
    #seasonalityAccordion .accordion-button.collapsed {
        background-color: #0d6efd; /* Bootstrap primary blue */
        color: white;
    }

    #seasonalityAccordion .accordion-button:not(.collapsed) {
        background-color: #e9ecef; /* A light grey for the expanded state */
        color: #212529; /* Default dark text color */
    }

    /* Ensure the expand/collapse icon is white on the blue background */
    #seasonalityAccordion .accordion-button.collapsed::after {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='white'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }

    /* Make the muted helper text lighter on the blue background */
    #seasonalityAccordion .accordion-button.collapsed .text-muted {
        color: #f8f9fa !important; /* A light grey/white for contrast */
    }

    /* Custom styles for the itemized accordion button */
    #itemizedAccordion .accordion-button.collapsed {
        background-color: #0d6efd; /* Bootstrap primary blue */
        color: white;
    }

    #itemizedAccordion .accordion-button:not(.collapsed) {
        background-color: #e9ecef; /* A light grey for the expanded state */
        color: #212529; /* Default dark text color */
    }

    /* Ensure the expand/collapse icon is white on the blue background */
    #itemizedAccordion .accordion-button.collapsed::after {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='white'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }

    #itemizedAccordion .accordion-button.collapsed .text-muted {
        color: #f8f9fa !important;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Financial Parameters -->
    <div class="card mb-4">
        <div class="card-header">
            <h2>Financial Parameters</h2>
        </div>
        <div class="card-body">
            <div class="accordion" id="itemizedAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingItemized">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseItemized" aria-expanded="false" aria-controls="collapseItemized">
                            Itemized Assets & Liabilities
                        </button>
                    </h2>
                    <div id="collapseItemized" class="accordion-collapse collapse" aria-labelledby="headingItemized" data-bs-parent="#itemizedAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <!-- Itemized Assets -->
                                <div class="col-lg-6">
                                    <h5 class="ratio-group-title">Itemized Assets</h5>
                                    <table class="table table-sm">
                                        <tbody id="assets-table-body">
                                            {% for asset in assets %}
                                            <tr>
                                                <td><input type="text" class="form-control form-control-sm asset-description" value="{{ asset.description }}"></td>
                                                <td><input type="text" class="form-control form-control-sm number-input asset-amount" value="{{ '{:,.0f}'.format(asset.amount) }}"></td>
                                                <td><button class="btn btn-sm btn-outline-danger remove-row-btn">&times;</button></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <button id="add-asset-btn" class="btn btn-sm btn-outline-primary">+ Add Asset</button>
                                </div>
                                <!-- Itemized Liabilities -->
                                <div class="col-lg-6">
                                    <h5 class="ratio-group-title">Itemized Liabilities (Debt)</h5>
                                    <table class="table table-sm">
                                        <tbody id="liabilities-table-body">
                                            {% for liability in liabilities %}
                                            <tr>
                                                <td><input type="text" class="form-control form-control-sm liability-description" value="{{ liability.description }}"></td>
                                                <td><input type="text" class="form-control form-control-sm number-input liability-amount" value="{{ '{:,.0f}'.format(liability.amount) }}"></td>
                                                <td><button class="btn btn-sm btn-outline-danger remove-row-btn">&times;</button></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <button id="add-liability-btn" class="btn btn-sm btn-outline-primary">+ Add Liability</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <!-- Operational Parameters -->
                <div class="col-lg-6">
                    <h5 class="ratio-group-title">Operational</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cogsPercentage" class="form-label">COGS: <span id="cogsValue">{{ cogs_percentage }}</span>%</label>
                            <input type="range" class="form-range" id="cogsPercentage" value="{{ cogs_percentage }}" min="0" max="100" step="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taxRate" class="form-label">Tax Rate: <span id="taxRateValue">{{ tax_rate }}</span>%</label>
                            <input type="range" class="form-range" id="taxRate" value="{{ tax_rate }}" min="0" max="50" step="0.5">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="annualExpenses" class="form-label">Annual Operating Expenses ($)</label>
                            <input type="number" class="form-control" id="annualExpenses" value="{{ annual_operating_expenses }}" step="100" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="depreciation" class="form-label">Annual Depreciation ($)</label>
                            <input type="text" class="form-control number-input" id="depreciation" value="{{ '{:,.0f}'.format(depreciation) }}" step="100">
                        </div>
                    </div>
                </div>
                <!-- Balance Sheet Parameters -->
                <div class="col-lg-6">
                    <h5 class="ratio-group-title">Balance Sheet</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="currentAssets" class="form-label">Current Assets ($)</label><input type="text" class="form-control number-input" id="currentAssets" value="{{ '{:,.0f}'.format(current_assets) }}"></div>
                        <div class="col-md-6 mb-3"><label for="currentLiabilities" class="form-label">Current Liabilities ($)</label><input type="text" class="form-control number-input" id="currentLiabilities" value="{{ '{:,.0f}'.format(current_liabilities) }}"></div>
                        <div class="col-md-6 mb-3"><label for="totalAssets" class="form-label">Total Assets ($)</label><input type="text" class="form-control number-input" id="totalAssets" value="{{ '{:,.0f}'.format(total_assets) }}" readonly></div>
                        <div class="col-md-6 mb-3"><label for="totalDebt" class="form-label">Total Debt ($)</label><input type="text" class="form-control number-input" id="totalDebt" value="{{ '{:,.0f}'.format(total_debt) }}" readonly></div>
                        <div class="col-md-6 mb-3"><label for="interestExpense" class="form-label">Annual Interest Expense ($)</label><input type="text" class="form-control number-input" id="interestExpense" value="{{ '{:,.0f}'.format(interest_expense) }}" step="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seasonality -->
    <div class="accordion" id="seasonalityAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingSeasonality">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeasonality" aria-expanded="false" aria-controls="collapseSeasonality">
                    Seasonality Adjustment <small class="text-muted ms-2">(e.g., 1.2 for 20% busier, 0.8 for 20% slower)</small>
                </button>
            </h2>
            <div id="collapseSeasonality" class="accordion-collapse collapse" aria-labelledby="headingSeasonality" data-bs-parent="#seasonalityAccordion">
                <div class="accordion-body">
                    <div id="seasonality-inputs" class="row">
                        {% set months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                        {% for i in range(12) %}
                        <div class="col-md-1 col-sm-3 mb-2">
                            <label for="seasonality-{{ i }}" class="form-label small">{{ months[i] }}</label>
                            <input type="number" class="form-control form-control-sm seasonality-input" 
                                   id="seasonality-{{ i }}" 
                                   value="{{ seasonality[i] }}" 
                                   step="0.1" 
                                   min="0">
                        </div>
                        {% endfor %}
                        <div class="col-12 mt-2">
                            <button id="normalize-seasonality" class="btn btn-sm btn-outline-secondary">Normalize (Set Average to 1)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forecast Results -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2>Forecast Results</h2>
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                <input type="radio" class="btn-check" name="viewToggle" id="annual-view" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="annual-view">Annual</label>

                <input type="radio" class="btn-check" name="viewToggle" id="quarterly-view" autocomplete="off">
                <label class="btn btn-outline-primary" for="quarterly-view">Quarterly</label>
            </div>
        </div>
        <div class="card-body">
            {% if forecast %}
            <div class="row text-center">
                <!-- Core Metrics -->
                <div class="col-md-6">
                    <div class="stat-box">
                        <div class="stat-title">Total Revenue</div>
                        <div class="stat-value text-primary" id="revenue-display"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-box">
                        <div class="stat-title">Net Profit</div>
                        <div class="stat-value text-success" id="net-profit-display"></div>
                    </div>
                </div>
            </div>
            <hr>
            <!-- Ratio Groups -->
            <div class="row text-center mt-3">
                <!-- Profitability -->
                <div class="col-md-3">
                    <h5 class="ratio-group-title">Profitability</h5>
                    <div class="stat-box mb-2">
                        <div class="stat-title">
                            Profit Margin
                            <a href="{{ url_for('library') }}#profitability-ratios" class="text-decoration-none" title="What is Profit Margin?">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                            </a>
                        </div>
                        <div class="stat-value text-info" id="profit-margin-display"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">
                            Return on Assets (ROA)
                            <a href="{{ url_for('library') }}#profitability-ratios" class="text-decoration-none" title="What is ROA?">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                            </a>
                        </div>
                        <div class="stat-value text-warning" id="roa-display"></div>
                    </div>
                </div>
                <!-- Liquidity -->
                <div class="col-md-3">
                    <h5 class="ratio-group-title">Liquidity</h5>
                    <div class="stat-box">
                        <div class="stat-title">
                            Current Ratio
                            <a href="{{ url_for('library') }}#liquidity-ratios" class="text-decoration-none" title="What is the Current Ratio?">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                            </a>
                        </div>
                        <div class="stat-value" id="current-ratio-display"></div>
                    </div>
                </div>
                <!-- Solvency -->
                <div class="col-md-3">
                    <h5 class="ratio-group-title">Solvency</h5>
                    <div class="stat-box mb-2">
                        <div class="stat-title">
                            Debt-to-Equity Ratio
                            <a href="{{ url_for('library') }}#solvency-ratios" class="text-decoration-none" title="What is the D/E Ratio?">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                            </a>
                        </div>
                        <div class="stat-value" id="de-ratio-display"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">
                            Interest Coverage Ratio
                            <a href="{{ url_for('library') }}#solvency-ratios" class="text-decoration-none" title="What is the ICR?">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                            </a>
                        </div>
                        <div class="stat-value" id="icr-display"></div>
                    </div>
                </div>
                <!-- Cash Flow -->
                <div class="col-md-3">
                    <h5 class="ratio-group-title">Cash Flow</h5>
                    <div class="stat-box">
                        <div class="stat-title">
                            Operating Cash Flow Ratio
                            <a href="{{ url_for('library') }}#cash-flow-ratios" class="text-decoration-none" title="What is the OCF Ratio?">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>
                            </a>
                        </div>
                        <div class="stat-value" id="ocf-ratio-display"></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info" role="alert">
                Your financial forecast will be displayed here once you enter your <a href="{{ url_for('product_detail') }}">product detail.
            </div>
            {% endif %}
            <!-- This section was moved and restructured -->
            <div class="row text-center" style="display: none;">
                <div class="col-md-6 mt-3">
                    <div class="stat-box">
                        <div class="stat-title">Leverage Ratio (old)</div>
                        <div class="stat-value" id="leverage-ratio-display"></div>
                    </div>
                </div>
                <div class="col-md-6 mt-3">
                    <div class="stat-box">
                        <div class="stat-title">Interest Coverage Ratio</div>
                        <div class="stat-value" id="icr-display"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row">
        <!-- Monthly Cash Flow Chart -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Monthly Net Profit (Cash Flow)</h2>
                </div>
                <div class="card-body">
                    {% if forecast and forecast.monthly %}
                    <div style="position: relative; height:250px; width:100%">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Revenue vs Expenses Chart -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Monthly Revenue vs. Expenses</h2>
                </div>
                <div class="card-body">
                    {% if forecast and forecast.monthly %}
                    <div style="position: relative; height:250px; width:100%">
                        <canvas id="revenueExpenseChart"></canvas>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="d-flex justify-content-between my-4">
        <a href="{{ url_for('product_detail') }}" class="btn btn-light">&larr; Back to Product Details</a>
        <a href="{{ url_for('loan_calculator') }}" class="btn btn-primary">Assess Loan Affordability &rarr;</a>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Store the forecast data passed from the backend
    const forecastData = {{ forecast | tojson | safe }};

    // Function to format numbers as currency
    const formatCurrency = (value) => {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    };

    // --- Number Formatting ---
    const formatNumberInput = (num) => {
        if (num === null || num === undefined || num === '') return '';
        const number = parseFloat(String(num).replace(/,/g, ''));
        return isNaN(number) ? '' : number.toLocaleString('en-US');
    };

    const parseFormattedNumber = (str) => {
        if (typeof str !== 'string') return str;
        return parseFloat(str.replace(/,/g, '')) || 0;
    };

    let cashFlowChart;
    let revenueExpenseChart;
    const drawCashFlowChart = () => {
        if (!forecastData || !forecastData.monthly) return;

        const ctx = document.getElementById('cashFlowChart').getContext('2d');
        const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const data = forecastData.monthly.map(m => m.net_profit);

        if (cashFlowChart) {
            cashFlowChart.data.datasets[0].data = data; // Update data
            cashFlowChart.update();
        } else {
            cashFlowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Net Profit',
                        data: data,
                        backgroundColor: data.map(v => v < 0 ? 'rgba(255, 99, 132, 0.7)' : 'rgba(75, 192, 192, 0.7)'),
                        borderColor: data.map(v => v < 0 ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { tooltip: { callbacks: { label: (c) => `Net Profit: ${formatCurrency(c.raw)}` } } }
                }
            });
        }
    };

    const drawRevenueExpenseChart = () => {
        if (!forecastData || !forecastData.monthly) return;

        const ctx = document.getElementById('revenueExpenseChart').getContext('2d');
        const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const revenueData = forecastData.monthly.map(m => m.revenue);
        const expenseData = forecastData.monthly.map(m => m.cogs + m.operating_expenses + m.tax); // Total expenses including tax
        const netProfitData = forecastData.monthly.map(m => m.net_profit);

        if (revenueExpenseChart) {
            revenueExpenseChart.data.datasets[0].data = expenseData;
            revenueExpenseChart.data.datasets[1].data = netProfitData;
            revenueExpenseChart.update();
        } else {
            revenueExpenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Expenses (COGS + OpEx + Tax)',
                        data: expenseData,
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    }, {
                        label: 'Net Profit',
                        data: netProfitData,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatCurrency(c.raw)}` } }
                    }
                }
            });
        }
    };

    // Function to update the display based on the selected view
    const updateDisplay = (view) => {
        if (!forecastData) return;

        const data = forecastData[view];
        document.getElementById('revenue-display').textContent = formatCurrency(data.revenue);
        document.getElementById('net-profit-display').textContent = formatCurrency(data.net_profit);
        document.getElementById('profit-margin-display').textContent = data.profit_margin.toFixed(2) + '%';
        document.getElementById('roa-display').textContent = data.roa.toFixed(2) + '%'; // New: Update ROA display
        document.getElementById('current-ratio-display').textContent = data.current_ratio.toFixed(2);
        document.getElementById('de-ratio-display').textContent = data.debt_to_equity_ratio.toFixed(2);
        document.getElementById('icr-display').textContent = data.interest_coverage_ratio.toFixed(2);
        document.getElementById('ocf-ratio-display').textContent = data.operating_cash_flow_ratio.toFixed(2);
    };

    // Event listeners for the view toggle
    document.getElementById('annual-view').addEventListener('change', () => updateDisplay('annual'));
    document.getElementById('quarterly-view').addEventListener('change', () => updateDisplay('quarterly'));

    // Initial display update
    document.addEventListener('DOMContentLoaded', () => {
        drawCashFlowChart();
        drawRevenueExpenseChart();
        updateDisplay('annual'); // Default to annual view
    });

    // --- Recalculation Logic ---
    const cogsSlider = document.getElementById('cogsPercentage');
    const cogsValue = document.getElementById('cogsValue');
    const taxSlider = document.getElementById('taxRate');
    const taxValue = document.getElementById('taxRateValue');
    const annualExpensesInput = document.getElementById('annualExpenses');
    const totalAssetsInput = document.getElementById('totalAssets');
    const totalDebtInput = document.getElementById('totalDebt');
    const interestExpenseInput = document.getElementById('interestExpense');
    const currentAssetsInput = document.getElementById('currentAssets');
    const currentLiabilitiesInput = document.getElementById('currentLiabilities');
    const depreciationInput = document.getElementById('depreciation');
    const seasonalityInputs = document.querySelectorAll('.seasonality-input');

    // --- Itemized List Management ---
    const updateTotals = () => {
        const totalAssets = Array.from(document.querySelectorAll('.asset-amount')).reduce((sum, input) => sum + parseFormattedNumber(input.value), 0);
        totalAssetsInput.value = formatNumberInput(totalAssets);

        const totalDebt = Array.from(document.querySelectorAll('.liability-amount')).reduce((sum, input) => sum + parseFormattedNumber(input.value), 0);
        totalDebtInput.value = formatNumberInput(totalDebt);
    };

    const recalculate = () => {
        const cogs = cogsSlider.value;
        const expenses = annualExpensesInput.value;
        const tax = taxSlider.value;
        const assets = parseFormattedNumber(totalAssetsInput.value);
        const debt = parseFormattedNumber(totalDebtInput.value);
        const interest = parseFormattedNumber(interestExpenseInput.value);
        const currentAssets = parseFormattedNumber(currentAssetsInput.value);
        const currentLiabilities = parseFormattedNumber(currentLiabilitiesInput.value);
        const depreciation = parseFormattedNumber(depreciationInput.value);
        const seasonality = Array.from(seasonalityInputs).map(input => parseFloat(input.value) || 0);
        
        const assetsList = Array.from(document.querySelectorAll('#assets-table-body tr')).map(row => ({
            description: row.querySelector('.asset-description').value,
            amount: parseFormattedNumber(row.querySelector('.asset-amount').value)
        }));

        const liabilitiesList = Array.from(document.querySelectorAll('#liabilities-table-body tr')).map(row => ({
            description: row.querySelector('.liability-description').value,
            amount: parseFormattedNumber(row.querySelector('.liability-amount').value)
        }));

        cogsValue.textContent = cogs;
        taxValue.textContent = tax;

        fetch('/recalculate-forecast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                cogs_percentage: cogs,
                annual_operating_expenses: expenses,
                tax_rate: tax,
                seasonality: seasonality,
                assets: assetsList,
                liabilities: liabilitiesList,
                interest_expense: interest,
                current_assets: currentAssets,
                current_liabilities: currentLiabilities,
                depreciation: depreciation,
            }),
        })
        .then(response => response.json())
        .then(newForecast => {
            // Update the global forecast data
            forecastData.annual = newForecast.annual;
            forecastData.quarterly = newForecast.quarterly;
            forecastData.monthly = newForecast.monthly;

            // Update the display based on the currently selected view
            const selectedView = document.getElementById('annual-view').checked ? 'annual' : 'quarterly';
            updateDisplay(selectedView);
            drawCashFlowChart(); // Redraw the cash flow chart
            drawRevenueExpenseChart(); // Redraw the new revenue/expense chart
        })
        .catch(error => console.error('Error recalculating forecast:', error));
    };

    cogsSlider.addEventListener('input', recalculate);
    taxSlider.addEventListener('input', recalculate);
    annualExpensesInput.addEventListener('input', recalculate);
    interestExpenseInput.addEventListener('input', recalculate);
    currentAssetsInput.addEventListener('input', recalculate);
    currentLiabilitiesInput.addEventListener('input', recalculate);
    depreciationInput.addEventListener('input', recalculate);
    seasonalityInputs.forEach(input => input.addEventListener('input', recalculate));

    const addRow = (tbodyId, descClass, amountClass) => {
        const tbody = document.getElementById(tbodyId);
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control form-control-sm ${descClass}" value=""></td>
            <td><input type="text" class="form-control form-control-sm number-input ${amountClass}" value="0"></td>
            <td><button class="btn btn-sm btn-outline-danger remove-row-btn">&times;</button></td>
        `;
        tbody.appendChild(newRow);
        // Add listeners to new elements
        newRow.querySelector('.remove-row-btn').addEventListener('click', (e) => {
            e.target.closest('tr').remove();
            updateTotals();
            recalculate();
        });
        newRow.querySelectorAll('input').forEach(input => input.addEventListener('input', () => {
            updateTotals();
            recalculate();
        }));
        newRow.querySelector('.number-input').addEventListener('focusout', (e) => {
            e.target.value = formatNumberInput(e.target.value);
        });
    };

    document.getElementById('add-asset-btn').addEventListener('click', () => addRow('assets-table-body', 'asset-description', 'asset-amount'));
    document.getElementById('add-liability-btn').addEventListener('click', () => addRow('liabilities-table-body', 'liability-description', 'liability-amount'));

    // Add focusout listener for formatting number inputs
    document.querySelectorAll('.number-input').forEach(input => {
        // Add input listeners to all number inputs for live recalculation
        input.addEventListener('input', () => {
            updateTotals();
            recalculate();
        });
        input.addEventListener('focusout', (e) => {
            e.target.value = formatNumberInput(e.target.value);
        });
    });

    // Seasonality normalization
    document.getElementById('normalize-seasonality').addEventListener('click', () => {
        const inputs = Array.from(seasonalityInputs);
        const values = inputs.map(input => parseFloat(input.value) || 0);
        const total = values.reduce((sum, val) => sum + val, 0);

        if (total > 0) {
            const normalizedValues = values.map(val => (val / total) * 12);
            inputs.forEach((input, index) => {
                input.value = normalizedValues[index].toFixed(2);
            });
            recalculate(); // Trigger recalculation after normalizing
        }
    });

    // Add listeners to initially loaded rows
    document.querySelectorAll('.remove-row-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.target.closest('tr').remove();
            updateTotals();
            recalculate();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}